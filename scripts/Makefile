# This Makefile is supposed to run on the Travis CI server and also locally

BUILD_DIR=build
SOURCEFILE = CppCoreGuidelines.md
SOURCEPATH = ../$(SOURCEFILE)

.PHONY: default
default: all

.PHONY: all
all: \
check-markdown


#### clean: remove all files generated by any of the targets
.PHONY: clean
clean:
	rm -rf $(BUILD_DIR)


#### check markdown

# run mdast markdown checker based on configuration in .mastrc
.PHONY: check-markdown
check-markdown: nodejs/node_modules/.bin/mdast nodejs/mdast/.mdastrc $(SOURCEPATH)
	mkdir -p $(BUILD_DIR)
# run mdast, paste output to temporary file
	./nodejs/node_modules/.bin/mdast $(SOURCEPATH) --no-color -q --config-path ./nodejs/mdast/.mdastrc 1> $(BUILD_DIR)/$(SOURCEFILE).fixed
# compare temporary file to original, error and fail with message if differences exist
	diff $(SOURCEPATH) $(BUILD_DIR)/$(SOURCEFILE).fixed -u3 || \
(echo "Error: mdast found bad markdown syntax, see diff above" && false)



#### install npm modules

nodejs/node_modules/.bin/mdast: npm-install

# install/update npm dependencies defined in file package.json
# requires npm (nodejs package manager)
.PHONY: npm-install
npm-install: nodejs/package.json
	cd nodejs; npm install
